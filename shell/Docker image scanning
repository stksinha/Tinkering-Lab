#!/bin/bash

# --- Configuration ---
SCAN_DIR="/opt/qualys-scanner"
REPORT_PATH="$SCAN_DIR/monthly_scanning/scan_report.txt"
LOG_DIR="$SCAN_DIR/monthly_scanning/output"

# Load Credentials (Ensure this file is secured!)
. "$SCAN_DIR/access-token"

echo "########################### Monthly Image Scan Report #####################################" > "$REPORT_PATH"

# Extract Image IDs (skipping header)
docker images --format "{{.ID}}" > "$SCAN_DIR/monthly_scanning/image_list.txt"

while IFS= read -r image_id; do
    # Capture metadata using modern syntax
    image_name=$(docker images --format "{{.Repository}}" --filter "reference=$image_id")
    image_tag=$(docker images --format "{{.Tag}}" --filter "reference=$image_id")

    echo "Scanning started for: $image_name:$image_tag" >> "$REPORT_PATH"

    # Execute Qualys Scan
    "$SCAN_DIR/qscanner" image "$image_id" \
        --access-token "$QUALYS_ACCESS_TOKEN" \
        --pod "$QUALYS_API_URL" \
        --proxy "$PROXY_URL" \
        --report-format table \
        --output-dir "$SCAN_DIR/monthly_scanning/reports" > "$LOG_DIR/report_$image_id.out"

    # Extract results using AWK logic
    awk '/vulnerabilities found/ || /Severity/ { $1=""; $2=""; sub(/^+/,""); print }' "$LOG_DIR/report_$image_id.out" >> "$REPORT_PATH"
    
    # Extract the table for visual confirmation
    awk '/^\+/ {in_table=1} in_table {print} NF==0 {in_table=0}' "$LOG_DIR/report_$image_id.out" >> "$REPORT_PATH"

    echo "Scanning completed for: $image_name:$image_tag" >> "$REPORT_PATH"
    echo "###########################################################################################" >> "$REPORT_PATH"

done < "$SCAN_DIR/monthly_scanning/image_list.txt"

# Send Report
mailx -a "$REPORT_PATH" \
      -S from="Security Scanner <scanner@example.com>" \
      -s "Monthly Docker Image Scan Report" \
      admin@example.com < "$SCAN_DIR/monthly_scanning/message.txt"
